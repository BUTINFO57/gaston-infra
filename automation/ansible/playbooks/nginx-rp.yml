---
# =============================================================================
# nginx-rp.yml — Reverse Proxy NGINX sur rp-prod01
# Source : Runbook §4.8.3
# =============================================================================
- name: Déployer le Reverse Proxy NGINX
  hosts: rp-prod01
  become: true

  vars:
    site_domain: "les-saveurs-de-gaston.fr"
    wordpress_host: "192.168.20.108"
    admin_network: "192.168.10.0/24"
    vpn_network: "10.99.0.0/24"
    ssl_cert_path: "/etc/nginx/ssl/gaston.crt"
    ssl_key_path: "/etc/nginx/ssl/gaston.key"

  tasks:
    - name: Installer NGINX
      ansible.builtin.apt:
        name:
          - nginx
          - openssl
        state: present
        update_cache: true

    - name: Créer le répertoire SSL
      ansible.builtin.file:
        path: /etc/nginx/ssl
        state: directory
        mode: "0700"

    - name: Générer un certificat auto-signé
      ansible.builtin.shell: |
        openssl req -x509 -nodes -days 365 \
          -newkey rsa:2048 \
          -keyout {{ ssl_key_path }} \
          -out {{ ssl_cert_path }} \
          -subj "/CN={{ site_domain }}/O=Les Saveurs de Gaston"
      args:
        creates: "{{ ssl_cert_path }}"

    - name: Déployer la config NGINX depuis le modèle
      ansible.builtin.template:
        src: templates/nginx-rp.conf.j2
        dest: /etc/nginx/sites-available/gaston
        mode: "0644"
      notify: recharger nginx

    - name: Activer le site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/gaston
        dest: /etc/nginx/sites-enabled/gaston
        state: link
      notify: recharger nginx

    - name: Supprimer le site par défaut
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: recharger nginx

    - name: Valider la configuration NGINX
      ansible.builtin.command: nginx -t
      changed_when: false

    - name: S'assurer que NGINX est en cours d'exécution
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

  handlers:
    - name: recharger nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
